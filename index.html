<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Upgrade Me: Ultimate</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-link: var(--tg-theme-link-color, #2481cc);
            --tg-sec-bg: var(--tg-theme-secondary-bg-color, #f4f4f5);
            --gold: #ffcf40;
        }

        body { font-family: sans-serif; background: var(--tg-bg); color: var(--tg-text); margin: 0; padding-bottom: 80px; overflow-x: hidden; }

        /* –•–µ–¥–µ—Ä */
        .header { display: flex; justify-content: space-between; padding: 15px; background: var(--tg-sec-bg); font-weight: bold; position: sticky; top: 0; z-index: 10; }
        .coin-balance { color: var(--gold); font-size: 18px; }

        /* –ü–∏—Ç–æ–º–µ—Ü */
        #pet-container { position: fixed; top: 70px; right: 10px; font-size: 40px; z-index: 100; display: none; animation: float 2s infinite ease-in-out; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü */
        .page { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ –∏ –°–µ—Ç–∫–∏ */
        .meditation-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; }
        .med-card { aspect-ratio: 1/1; background: var(--tg-sec-bg); border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid rgba(0,0,0,0.05); cursor: pointer; text-align: center; }
        .med-card .icon { font-size: 32px; margin-bottom: 8px; }

        .info-card { background: var(--tg-sec-bg); border-radius: 20px; padding: 15px; margin-bottom: 15px; }

        /* –ü–ª–µ–µ—Ä –∏ –û–≤–µ—Ä–ª–µ–∏ */
        .overlay { display: none; position: fixed; inset: 0; background: var(--tg-bg); z-index: 500; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .blob { position: absolute; width: 300px; height: 300px; background: linear-gradient(45deg, var(--tg-link), #a2d2ff); filter: blur(80px); border-radius: 50%; z-index: -1; animation: move 8s infinite alternate ease-in-out; }
        @keyframes move { from { transform: translate(-30%, -30%); } to { transform: translate(30%, 30%); } }

        /* –ö–Ω–æ–ø–∫–∏ –∏ —Ñ–æ—Ä–º—ã */
        .btn-main { background: var(--tg-link); color: white; border: none; border-radius: 12px; padding: 15px; width: 100%; font-weight: bold; margin-top: 10px; cursor: pointer; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #ccc; background: var(--tg-bg); color: var(--tg-text); box-sizing: border-box; }

        /* –¢–∞–±-–±–∞—Ä */
        .tab-bar { position: fixed; bottom: 0; width: 100%; display: flex; background: var(--tg-sec-bg); height: 65px; border-top: 1px solid rgba(0,0,0,0.1); }
        .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; opacity: 0.5; color: var(--tg-text); text-decoration: none; }
        .active-tab { opacity: 1; color: var(--tg-link); font-weight: bold; }

        /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –ø–ª–µ–µ—Ä–∞ */
        .progress-container { width: 80%; height: 6px; background: rgba(0,0,0,0.1); border-radius: 3px; margin: 25px 0; overflow: hidden; }
        #progress-fill { width: 0%; height: 100%; background: var(--tg-link); }

        /* –ò—Å—Ç–æ—Ä–∏—è –µ–¥—ã */
        #food-history { max-height: 120px; overflow-y: auto; text-align: left; margin-top: 10px; font-size: 14px; }
        .history-item { padding: 5px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
    </style>
</head>
<body>

    <div id="pet-container">üê±</div>

    <div class="header">
        <span>Upgrade Me</span>
        <div class="coin-balance">ü™ô <span id="coinCount">0</span></div>
    </div>

    <div id="meditation" class="page active">
        <h3>–ú–µ–¥–∏—Ç–∞—Ü–∏–∏ üßò</h3>
        <div class="meditation-grid">
            <div class="med-card" onclick="openPlayer('–°–æ–Ω', 'üåô', 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3')"><span class="icon">üåô</span><span>–°–æ–Ω</span></div>
            <div class="med-card" onclick="openPlayer('–ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å', 'üôè', 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3')"><span class="icon">üôè</span><span>–ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å</span></div>
            <div class="med-card" onclick="openPlayer('–°—á–∞—Å—Ç—å–µ', '‚òÄÔ∏è', 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3')"><span class="icon">‚òÄÔ∏è</span><span>–°—á–∞—Å—Ç—å–µ</span></div>
            <div class="med-card" onclick="openPlayer('–§–æ–∫—É—Å', 'üéØ', 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3')"><span class="icon">üéØ</span><span>–§–æ–∫—É—Å</span></div>
            <div class="med-card" onclick="openPlayer('–≠–Ω–µ—Ä–≥–∏—è', '‚ö°', 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3')"><span class="icon">‚ö°</span><span>–≠–Ω–µ—Ä–≥–∏—è</span></div>
            <div class="med-card" onclick="openPlayer('–ù–∞ –¥–µ–Ω—å', 'üåÖ', 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3')"><span class="icon">üåÖ</span><span>–ù–∞ –¥–µ–Ω—å</span></div>
        </div>
    </div>

    <div id="bju" class="page">
        <h3>–¢—Ä–µ–∫–µ—Ä –ë–ñ–£ ü•ó</h3>
        <div id="bju-setup">
            <p>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –Ω–æ—Ä–º—ã:</p>
            <input type="number" id="weight" placeholder="–í–µ—Å (–∫–≥)">
            <input type="number" id="height" placeholder="–†–æ—Å—Ç (—Å–º)">
            <input type="number" id="age" placeholder="–í–æ–∑—Ä–∞—Å—Ç">
            <select id="gender">
                <option value="male">–ú—É–∂—á–∏–Ω–∞</option>
                <option value="female">–ñ–µ–Ω—â–∏–Ω–∞</option>
            </select>
            <button class="btn-main" onclick="calcBJU()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
        </div>

        <div id="bju-tracker" style="display:none;">
            <div class="info-card">
                <h2 id="curr-cal">–û—Å—Ç–∞–ª–æ—Å—å: 0 –∫–∫–∞–ª</h2>
                <div style="display: flex; justify-content: space-around; margin-top: 10px;">
                    <div><b>–ë:</b> <span id="curr-b">0</span>–≥</div>
                    <div><b>–ñ:</b> <span id="curr-j">0</span>–≥</div>
                    <div><b>–£:</b> <span id="curr-u">0</span>–≥</div>
                </div>
            </div>

            <div class="info-card">
                <h4>–î–æ–±–∞–≤–∏—Ç—å –µ–¥—É</h4>
                <input type="text" id="food-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <input type="number" id="f-cal" placeholder="–ö–∫–∞–ª">
                    <input type="number" id="f-b" placeholder="–ë–µ–ª–∫–∏">
                    <input type="number" id="f-j" placeholder="–ñ–∏—Ä—ã">
                    <input type="number" id="f-u" placeholder="–£–≥–ª–µ–≤–æ–¥—ã">
                </div>
                <button class="btn-main" onclick="addMeal()">–Ø –ø–æ–µ–ª(–∞) üçΩÔ∏è</button>
            </div>

            <div class="info-card">
                <h4>–ò—Å—Ç–æ—Ä–∏—è –∑–∞ —Å–µ–≥–æ–¥–Ω—è</h4>
                <div id="food-history"></div>
            </div>
            
            <button onclick="resetBJU()" style="background:none; border:none; color:var(--tg-hint); width:100%;">–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
        </div>
    </div>

    <div id="workout" class="page">
        <h3>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ üí™</h3>
        <div class="med-card" style="width:100%; aspect-ratio: auto; padding: 20px; margin-bottom: 10px;" onclick="initWorkout('–¢—Ä–∏—Ü–µ–ø—Å')">üí™ –¢—Ä–∏—Ü–µ–ø—Å</div>
        <div class="med-card" style="width:100%; aspect-ratio: auto; padding: 20px;" onclick="initWorkout('–ë–∏—Ü–µ–ø—Å')">‚úä –ë–∏—Ü–µ–ø—Å</div>
    </div>

    <div id="shop" class="page">
        <h3>–ú–∞–≥–∞–∑–∏–Ω üõí</h3>
        <div class="med-card" style="width:100%; aspect-ratio: auto; padding: 20px;">
            <span style="font-size:40px">üê±</span>
            <h4>–ö–æ—Ç-–∫–æ–º–ø–∞–Ω—å–æ–Ω</h4>
            <p>–õ–µ—Ç–∞–µ—Ç —Ä—è–¥–æ–º –∏ —Ä–∞–¥—É–µ—Ç –≥–ª–∞–∑</p>
            <button class="btn-main" id="buyPetBtn" onclick="buyPet(50)">–ö—É–ø–∏—Ç—å –∑–∞ 50 ü™ô</button>
        </div>
    </div>

    <div id="player-overlay" class="overlay">
        <div class="blob"></div>
        <h1 id="playing-title"></h1>
        <div id="playing-icon" style="font-size: 80px; margin: 20px;"></div>
        <div class="progress-container"><div id="progress-fill"></div></div>
        <button class="btn-main" id="play-pause-btn" style="width:200px" onclick="togglePlay()">–ü–∞—É–∑–∞</button>
        <button onclick="requestClosePlayer()" style="background:none; border:none; color:var(--tg-hint); margin-top:20px;">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
    </div>

    <div id="training-overlay" class="overlay">
        <h2 id="ex-title"></h2>
        <p id="ex-desc" style="padding: 0 30px;"></p>
        <button id="next-ex-btn" class="btn-main" style="width:200px">–î–∞–ª–µ–µ</button>
        <button onclick="finishWorkout(false)" style="background:none; border:none; color:var(--tg-hint); margin-top:20px;">–í—ã–π—Ç–∏</button>
    </div>

    <nav class="tab-bar">
        <div class="tab-item active-tab" onclick="openPage('meditation', this)"><span>üßò</span><span>–ú–µ–¥–∏—Ç–∞—Ü–∏—è</span></div>
        <div class="tab-item" onclick="openPage('bju', this)"><span>ü•ó</span><span>–ë–ñ–£</span></div>
        <div class="tab-item" onclick="openPage('workout', this)"><span>üí™</span><span>–ó–∞–ª</span></div>
        <div class="tab-item" onclick="openPage('shop', this)"><span>üõí</span><span>–ú–∞–≥–∞–∑–∏–Ω</span></div>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let coins = parseInt(localStorage.getItem('coins')) || 0;
        let hasPet = localStorage.getItem('hasPet') === 'true';
        
        // –î–∞–Ω–Ω—ã–µ –ë–ñ–£
        let bju = JSON.parse(localStorage.getItem('bjuData')) || {
            target: { cal:0, b:0, j:0, u:0 },
            curr: { cal:0, b:0, j:0, u:0 },
            history: [],
            date: new Date().toLocaleDateString()
        };

        let currentAudio = new Audio();
        let isMedFinished = false;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.getElementById('coinCount').innerText = coins;
        if(hasPet) {
            document.getElementById('pet-container').style.display = 'block';
            document.getElementById('buyPetBtn').innerText = "–ö—É–ø–ª–µ–Ω–æ";
            document.getElementById('buyPetBtn').disabled = true;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–º–µ–Ω—ã –¥–Ω—è –¥–ª—è –ë–ñ–£
        if (bju.date !== new Date().toLocaleDateString()) {
            bju.curr = {...bju.target};
            bju.history = [];
            bju.date = new Date().toLocaleDateString();
            saveBju();
        }
        if (bju.target.cal > 0) showBjuTracker();

        function updateCoins(n) {
            coins += n;
            document.getElementById('coinCount').innerText = coins;
            localStorage.setItem('coins', coins);
            if(n > 0) tg.HapticFeedback.notificationOccurred('success');
        }

        function openPage(id, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active-tab'));
            document.getElementById(id === 'meditation' ? 'meditation' : id).classList.add('active');
            el.classList.add('active-tab');
        }

        // –ü–õ–ï–ï–†
        function openPlayer(name, icon, url) {
            document.getElementById('playing-title').innerText = name;
            document.getElementById('playing-icon').innerText = icon;
            document.getElementById('player-overlay').style.display = 'flex';
            currentAudio.src = url;
            currentAudio.play();
            isMedFinished = false;
            currentAudio.ontimeupdate = () => {
                document.getElementById('progress-fill').style.width = (currentAudio.currentTime / currentAudio.duration * 100) + '%';
            };
            currentAudio.onended = () => {
                isMedFinished = true; updateCoins(20);
                tg.showAlert("–ì–æ—Ç–æ–≤–æ! +20 –º–æ–Ω–µ—Ç ü™ô");
                closePlayer();
            };
        }

        function togglePlay() {
            if (currentAudio.paused) { currentAudio.play(); document.getElementById('play-pause-btn').innerText = "–ü–∞—É–∑–∞"; }
            else { currentAudio.pause(); document.getElementById('play-pause-btn').innerText = "–ò–≥—Ä–∞—Ç—å"; }
        }

        function requestClosePlayer() {
            if(!isMedFinished) {
                tg.showConfirm("–ö–æ–∏–Ω—ã –Ω–µ –±—É–¥—É—Ç –Ω–∞—á–∏—Å–ª–µ–Ω—ã. –í—ã–π—Ç–∏?", (ok) => { if(ok) closePlayer(); });
            } else closePlayer();
        }

        function closePlayer() {
            currentAudio.pause();
            document.getElementById('player-overlay').style.display = 'none';
        }

        // –ë–ñ–£ –õ–û–ì–ò–ö–ê
        function calcBJU() {
            const w = document.getElementById('weight').value, h = document.getElementById('height').value, a = document.getElementById('age').value, g = document.getElementById('gender').value;
            if(!w || !h || !a) return tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏ –≤—Å—ë!");
            
            let c = Math.round((g === 'male') ? (10*w + 6.25*h - 5*a + 5) : (10*w + 6.25*h - 5*a - 161));
            bju.target = { cal: c, b: Math.round(c*0.3/4), j: Math.round(c*0.2/9), u: Math.round(c*0.5/4) };
            bju.curr = {...bju.target};
            saveBju();
            showBjuTracker();
        }

        function showBjuTracker() {
            document.getElementById('bju-setup').style.display = 'none';
            document.getElementById('bju-tracker').style.display = 'block';
            updateBjuUI();
        }

        function addMeal() {
            const name = document.getElementById('food-name').value || "–ï–¥–∞";
            const c = parseInt(document.getElementById('f-cal').value)||0, b = parseInt(document.getElementById('f-b').value)||0, j = parseInt(document.getElementById('f-j').value)||0, u = parseInt(document.getElementById('f-u').value)||0;
            
            bju.curr.cal -= c; bju.curr.b -= b; bju.curr.j -= j; bju.curr.u -= u;
            bju.history.unshift(`${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} - ${name} (${c}–∫–∫)`);
            
            saveBju(); updateBjuUI();
            ['food-name','f-cal','f-b','f-j','f-u'].forEach(id => document.getElementById(id).value = '');
        }

        function updateBjuUI() {
            document.getElementById('curr-cal').innerText = `–û—Å—Ç–∞–ª–æ—Å—å: ${bju.curr.cal} –∫–∫–∞–ª`;
            document.getElementById('curr-b').innerText = bju.curr.b;
            document.getElementById('curr-j').innerText = bju.curr.j;
            document.getElementById('curr-u').innerText = bju.curr.u;
            document.getElementById('food-history').innerHTML = bju.history.map(h => `<div class="history-item">${h}</div>`).join('') || "–ü–æ–∫–∞ –ø—É—Å—Ç–æ";
        }

        function saveBju() { localStorage.setItem('bjuData', JSON.stringify(bju)); }
        function resetBJU() { localStorage.removeItem('bjuData'); location.reload(); }

        // –¢–†–ï–ù–ò–†–û–í–ö–ò
        const workouts = { '–¢—Ä–∏—Ü–µ–ø—Å': [{n:'–ñ–∏–º',d:'–õ–æ–∫—Ç–∏ –Ω–∞–∑–∞–¥'},{n:'–û—Ç–∂–∏–º–∞–Ω–∏—è',d:'–†—É–∫–∏ —É–∑–∫–æ'}], '–ë–∏—Ü–µ–ø—Å': [{n:'–ü–æ–¥—ä–µ–º',d:'–ù–µ –∫–∞—á–∞–π—Å—è'},{n:'–ú–æ–ª–æ—Ç–∫–∏',d:'–•–≤–∞—Ç —Ä–æ–≤–Ω–æ'}] };
        let cL = [], cI = 0;
        function initWorkout(g) { cL = workouts[g]; cI = 0; document.getElementById('training-overlay').style.display = 'flex'; renderEx(); }
        function renderEx() { document.getElementById('ex-title').innerText = cL[cI].n; document.getElementById('ex-desc').innerText = cL[cI].d; document.getElementById('next-ex-btn').innerText = (cI === cL.length-1)?"–§–∏–Ω–∏—à":"–î–∞–ª–µ–µ"; }
        document.getElementById('next-ex-btn').onclick = () => { if(cI < cL.length-1){ cI++; renderEx(); } else finishWorkout(true); };
        function finishWorkout(s) { document.getElementById('training-overlay').style.display = 'none'; if(s){ updateCoins(50); tg.showAlert("+50 –º–æ–Ω–µ—Ç!"); } }

        // –ú–ê–ì–ê–ó–ò–ù
        function buyPet(p) { if(coins >= p){ updateCoins(-p); hasPet = true; localStorage.setItem('hasPet','true'); location.reload(); } else tg.showAlert("–ú–∞–ª–æ –º–æ–Ω–µ—Ç!"); }
    </script>
</body>
</html>
