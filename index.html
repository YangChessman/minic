<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Upgrade Me: Ultimate</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-link: var(--tg-theme-link-color, #2481cc);
            --tg-sec-bg: var(--tg-theme-secondary-bg-color, #f4f4f5);
            --gold: #ffcf40;
        }

        body { font-family: sans-serif; background: var(--tg-bg); color: var(--tg-text); margin: 0; padding-bottom: 80px; overflow-x: hidden; }

        /* –•–µ–¥–µ—Ä */
        .header { display: flex; justify-content: space-between; padding: 15px; background: var(--tg-sec-bg); font-weight: bold; position: sticky; top: 0; z-index: 10; }
        .coin-balance { color: var(--gold); font-size: 18px; }

        /* –ü–∏—Ç–æ–º–µ—Ü */
        #pet-container { position: fixed; top: 70px; right: 10px; font-size: 40px; z-index: 100; display: none; animation: float 2s infinite ease-in-out; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü */
        .page { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* –ú–µ–¥–∏—Ç–∞—Ü–∏—è: –°–µ—Ç–∫–∞ 2—Ö2 */
        .meditation-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; }
        .med-card { aspect-ratio: 1/1; background: var(--tg-sec-bg); border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid rgba(0,0,0,0.05); cursor: pointer; }
        .med-card:active { transform: scale(0.95); }
        .med-card .icon { font-size: 32px; margin-bottom: 8px; }

        /* –ü–ª–µ–µ—Ä –∏ –û–≤–µ—Ä–ª–µ–∏ */
        .overlay { display: none; position: fixed; inset: 0; background: var(--tg-bg); z-index: 500; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        
        .blob { position: absolute; width: 300px; height: 300px; background: linear-gradient(45deg, var(--tg-link), #a2d2ff); filter: blur(80px); border-radius: 50%; z-index: -1; animation: move 8s infinite alternate ease-in-out; }
        @keyframes move { from { transform: translate(-30%, -30%); } to { transform: translate(30%, 30%); } }

        /* –ö–Ω–æ–ø–∫–∏ –∏ —Ñ–æ—Ä–º—ã */
        .btn-main { background: var(--tg-link); color: white; border: none; border-radius: 12px; padding: 15px; width: 100%; font-weight: bold; margin-top: 10px; cursor: pointer; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #ccc; background: var(--tg-bg); color: var(--tg-text); box-sizing: border-box; }

        /* –¢–∞–±-–±–∞—Ä */
        .tab-bar { position: fixed; bottom: 0; width: 100%; display: flex; background: var(--tg-sec-bg); height: 65px; border-top: 1px solid rgba(0,0,0,0.1); }
        .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; opacity: 0.5; color: var(--tg-text); text-decoration: none; }
        .active-tab { opacity: 1; color: var(--tg-link); font-weight: bold; }

        /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –ø–ª–µ–µ—Ä–∞ */
        .progress-container { width: 80%; height: 6px; background: rgba(0,0,0,0.1); border-radius: 3px; margin: 25px 0; overflow: hidden; }
        #progress-fill { width: 0%; height: 100%; background: var(--tg-link); }
    </style>
</head>
<body>

    <div id="pet-container">üê±</div>

    <div class="header">
        <span>Upgrade Me</span>
        <div class="coin-balance">ü™ô <span id="coinCount">0</span></div>
    </div>

    <div id="meditation" class="page active">
        <h3>–ú–µ–¥–∏—Ç–∞—Ü–∏–∏ üßò</h3>
        <div class="meditation-grid">
            <div class="med-card" onclick="openPlayer('–°–æ–Ω', 'üåô', 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3')">
                <span class="icon">üåô</span><span>–°–æ–Ω</span>
            </div>
            <div class="med-card" onclick="openPlayer('–ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å', 'üôè', 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3')">
                <span class="icon">üôè</span><span>–ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å</span>
            </div>
            <div class="med-card" onclick="openPlayer('–°—á–∞—Å—Ç—å–µ', '‚òÄÔ∏è', 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3')">
                <span class="icon">‚òÄÔ∏è</span><span>–°—á–∞—Å—Ç—å–µ</span>
            </div>
            <div class="med-card" onclick="openPlayer('–§–æ–∫—É—Å', 'üéØ', 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3')">
                <span class="icon">üéØ</span><span>–§–æ–∫—É—Å</span>
            </div>
            <div class="med-card" onclick="openPlayer('–≠–Ω–µ—Ä–≥–∏—è', '‚ö°', 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3')">
                <span class="icon">‚ö°</span><span>–≠–Ω–µ—Ä–≥–∏—è</span>
            </div>
            <div class="med-card" onclick="openPlayer('–ù–∞ –¥–µ–Ω—å', 'üåÖ', 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3')">
                <span class="icon">üåÖ</span><span>–ù–∞ –¥–µ–Ω—å</span>
            </div>
        </div>
    </div>

    <div id="bju" class="page">
        <h3>–¢—Ä–µ–∫–µ—Ä –ë–ñ–£ ü•ó</h3>
        <div id="bju-setup">
            <p>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞:</p>
            <input type="number" id="weight" placeholder="–í–µ—Å (–∫–≥)">
            <input type="number" id="height" placeholder="–†–æ—Å—Ç (—Å–º)">
            <input type="number" id="age" placeholder="–í–æ–∑—Ä–∞—Å—Ç">
            <select id="gender">
                <option value="male">–ú—É–∂—á–∏–Ω–∞</option>
                <option value="female">–ñ–µ–Ω—â–∏–Ω–∞</option>
            </select>
            <button class="btn-main" onclick="calcBJU()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –Ω–æ—Ä–º—É</button>
        </div>
        <div id="bju-tracker" style="display:none;">
            <div class="med-card" style="width:100%; aspect-ratio: auto; padding: 20px; margin-bottom: 15px;">
                <h2 id="current-stats">–û—Å—Ç–∞–ª–æ—Å—å: 0 –∫–∫–∞–ª</h2>
                <small id="target-text">–ù–æ—Ä–º–∞: 0 –∫–∫–∞–ª</small>
            </div>
            <input type="text" id="food-name" placeholder="–ß—Ç–æ —Å—ä–µ–ª–∏? (–Ω–∞–ø—Ä. –°–Ω–∏–∫–µ—Ä—Å)">
            <input type="number" id="food-cal" placeholder="–ö–∞–ª–æ—Ä–∏–∏">
            <button class="btn-main" onclick="addMeal()">–î–æ–±–∞–≤–∏—Ç—å –µ–¥—É</button>
            <button onclick="resetBJU()" style="background:none; border:none; color:var(--tg-hint); margin-top:15px; width:100%;">–°–±—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        </div>
    </div>

    <div id="workout" class="page">
        <h3>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ üí™</h3>
        <div class="med-card" style="width:100%; aspect-ratio: auto; padding: 20px; margin-bottom: 10px;" onclick="initWorkout('–¢—Ä–∏—Ü–µ–ø—Å')">üí™ –¢—Ä–∏—Ü–µ–ø—Å</div>
        <div class="med-card" style="width:100%; aspect-ratio: auto; padding: 20px;" onclick="initWorkout('–ë–∏—Ü–µ–ø—Å')">‚úä –ë–∏—Ü–µ–ø—Å</div>
    </div>

    <div id="shop" class="page">
        <h3>–ú–∞–≥–∞–∑–∏–Ω üõí</h3>
        <div class="med-card" style="width:100%; aspect-ratio: auto; padding: 20px;">
            <span style="font-size:40px">üê±</span>
            <h4>–ö–æ—Ç-–∫–æ–º–ø–∞–Ω—å–æ–Ω</h4>
            <p>–ë—É–¥–µ—Ç –ª–µ—Ç–∞—Ç—å —Ä—è–¥–æ–º —Å –≤–∞–º–∏</p>
            <button class="btn-main" id="buyPetBtn" onclick="buyPet(50)">–ö—É–ø–∏—Ç—å –∑–∞ 50 ü™ô</button>
        </div>
    </div>

    <div id="player-overlay" class="overlay">
        <div class="blob"></div>
        <h1 id="playing-title">–ú–µ–¥–∏—Ç–∞—Ü–∏—è</h1>
        <div id="playing-icon" style="font-size: 100px; margin: 20px;">üßò</div>
        <div class="progress-container"><div id="progress-fill"></div></div>
        <button class="btn-main" id="play-pause-btn" style="width:200px" onclick="togglePlay()">–ü–∞—É–∑–∞</button>
        <button onclick="requestClosePlayer()" style="background:none; border:none; color:var(--tg-hint); margin-top:20px; cursor:pointer;">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
    </div>

    <div id="training-overlay" class="overlay">
        <h2 id="ex-title">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</h2>
        <p id="ex-desc" style="padding: 0 30px; line-height: 1.5;"></p>
        <button id="next-ex-btn" class="btn-main" style="width:200px">–°–ª–µ–¥—É—é—â–µ–µ ‚û°Ô∏è</button>
        <button onclick="finishWorkout()" style="background:none; border:none; color:var(--tg-hint); margin-top:20px;">–ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–æ—Å—Ä–æ—á–Ω–æ</button>
    </div>

    <nav class="tab-bar">
        <div class="tab-item active-tab" onclick="openPage('meditation', this)"><span>üßò</span><span>–ú–µ–¥–∏—Ç–∞—Ü–∏—è</span></div>
        <div class="tab-item" onclick="openPage('bju', this)"><span>ü•ó</span><span>–ë–ñ–£</span></div>
        <div class="tab-item" onclick="openPage('workout', this)"><span>üí™</span><span>–ó–∞–ª</span></div>
        <div class="tab-item" onclick="openPage('shop', this)"><span>üõí</span><span>–ú–∞–≥–∞–∑–∏–Ω</span></div>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let coins = parseInt(localStorage.getItem('coins')) || 0;
        let hasPet = localStorage.getItem('hasPet') === 'true';
        let dailyTarget = parseInt(localStorage.getItem('dailyTarget')) || 0;
        let currentCal = parseInt(localStorage.getItem('currentCal')) || 0;

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–ª–µ–µ—Ä–∞
        let currentAudio = new Audio();
        let isMeditationFinished = false;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.getElementById('coinCount').innerText = coins;
        if(hasPet) {
            document.getElementById('pet-container').style.display = 'block';
            document.getElementById('buyPetBtn').innerText = "–ö—É–ø–ª–µ–Ω–æ";
            document.getElementById('buyPetBtn').disabled = true;
        }
        if(dailyTarget > 0) {
            showBjuTracker();
        }

        function updateCoins(amount) {
            coins += amount;
            document.getElementById('coinCount').innerText = coins;
            localStorage.setItem('coins', coins);
            if(amount > 0) tg.HapticFeedback.notificationOccurred('success');
        }

        function openPage(pageId, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active-tab'));
            document.getElementById(pageId).classList.add('active');
            el.classList.add('active-tab');
        }

        // --- –õ–û–ì–ò–ö–ê –ü–õ–ï–ï–†–ê ---
        function openPlayer(name, icon, url) {
            document.getElementById('playing-title').innerText = name;
            document.getElementById('playing-icon').innerText = icon;
            document.getElementById('player-overlay').style.display = 'flex';
            
            currentAudio.src = url;
            currentAudio.play();
            isMeditationFinished = false;

            currentAudio.ontimeupdate = () => {
                const pct = (currentAudio.currentTime / currentAudio.duration) * 100;
                document.getElementById('progress-fill').style.width = pct + '%';
            };

            currentAudio.onended = () => {
                isMeditationFinished = true;
                updateCoins(20);
                tg.showAlert("–ú–µ–¥–∏—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –í—ã –ø–æ–ª—É—á–∏–ª–∏ 20 –∫–æ–∏–Ω–æ–≤ ü™ô");
                closePlayer();
            };
        }

        function togglePlay() {
            const btn = document.getElementById('play-pause-btn');
            if (currentAudio.paused) {
                currentAudio.play();
                btn.innerText = "–ü–∞—É–∑–∞";
            } else {
                currentAudio.pause();
                btn.innerText = "–ò–≥—Ä–∞—Ç—å";
            }
        }

        function requestClosePlayer() {
            if(!isMeditationFinished) {
                tg.showConfirm("–ï—Å–ª–∏ –∑–∞–∫—Ä—ã—Ç—å —Å–µ–π—á–∞—Å, –∫–æ–∏–Ω—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è—Ç—Å—è. –í—ã–π—Ç–∏?", (ok) => {
                    if(ok) closePlayer();
                });
            } else {
                closePlayer();
            }
        }

        function closePlayer() {
            currentAudio.pause();
            document.getElementById('player-overlay').style.display = 'none';
        }

        // --- –õ–û–ì–ò–ö–ê –ë–ñ–£ ---
        function calcBJU() {
            const w = document.getElementById('weight').value;
            const h = document.getElementById('height').value;
            const a = document.getElementById('age').value;
            const g = document.getElementById('gender').value;

            if(!w || !h || !a) return tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");

            dailyTarget = (g === 'male') 
                ? (10 * w) + (6.25 * h) - (5 * a) + 5 
                : (10 * w) + (6.25 * h) - (5 * a) - 161;

            dailyTarget = Math.round(dailyTarget);
            currentCal = dailyTarget;
            
            localStorage.setItem('dailyTarget', dailyTarget);
            localStorage.setItem('currentCal', currentCal);
            showBjuTracker();
        }

        function showBjuTracker() {
            document.getElementById('bju-setup').style.display = 'none';
            document.getElementById('bju-tracker').style.display = 'block';
            document.getElementById('target-text').innerText = `–ù–æ—Ä–º–∞: ${dailyTarget} –∫–∫–∞–ª`;
            updateBjuUI();
        }

        function addMeal() {
            const cal = document.getElementById('food-cal').value;
            if(!cal) return;
            currentCal -= cal;
            localStorage.setItem('currentCal', currentCal);
            updateBjuUI();
            document.getElementById('food-cal').value = '';
            document.getElementById('food-name').value = '';
        }

        function updateBjuUI() {
            document.getElementById('current-stats').innerText = `–û—Å—Ç–∞–ª–æ—Å—å: ${currentCal} –∫–∫–∞–ª`;
        }

        function resetBJU() {
            localStorage.removeItem('dailyTarget');
            document.getElementById('bju-setup').style.display = 'block';
            document.getElementById('bju-tracker').style.display = 'none';
        }

        // --- –õ–û–ì–ò–ö–ê –¢–†–ï–ù–ò–†–û–í–û–ö ---
        const db = {
            '–¢—Ä–∏—Ü–µ–ø—Å': [
                {n: '–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π –∂–∏–º', d: '–û–ø—É—Å–∫–∞–π—Ç–µ –≥–∞–Ω—Ç–µ–ª–∏ –∑–∞ –≥–æ–ª–æ–≤—É, –ª–æ–∫—Ç–∏ —Å–º–æ—Ç—Ä—è—Ç –≤ –ø–æ—Ç–æ–ª–æ–∫.'},
                {n: '–û–±—Ä–∞—Ç–Ω—ã–µ –æ—Ç–∂–∏–º–∞–Ω–∏—è', d: '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç—É–ª –∏–ª–∏ –¥–∏–≤–∞–Ω. –°–ø–∏–Ω–∞ –±–ª–∏–∑–∫–æ –∫ –æ–ø–æ—Ä–µ.'}
            ],
            '–ë–∏—Ü–µ–ø—Å': [
                {n: '–ü–æ–¥—ä–µ–º –Ω–∞ –±–∏—Ü–µ–ø—Å', d: '–õ–æ–∫—Ç–∏ –ø—Ä–∏–∂–∞—Ç—ã –∫ —Ç–µ–ª—É, –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –≤–µ—Å–∞.'},
                {n: '–ú–æ–ª–æ—Ç–∫–æ–≤—ã–µ —Å–≥–∏–±–∞–Ω–∏—è', d: '–î–µ—Ä–∂–∏—Ç–µ –≥–∞–Ω—Ç–µ–ª–∏ –∫–∞–∫ –º–æ–ª–æ—Ç–æ–∫, –ª–∞–¥–æ–Ω—è–º–∏ –∫ —Å–µ–±–µ.'}
            ]
        };
        let curList = [], curIdx = 0;

        function initWorkout(grp) {
            curList = db[grp]; curIdx = 0;
            document.getElementById('training-overlay').style.display = 'flex';
            renderEx();
        }

        function renderEx() {
            const ex = curList[curIdx];
            document.getElementById('ex-title').innerText = ex.n;
            document.getElementById('ex-desc').innerText = ex.d;
            document.getElementById('next-ex-btn').innerText = (curIdx === curList.length - 1) ? "–ó–∞–≤–µ—Ä—à–∏—Ç—å üéâ" : "–°–ª–µ–¥—É—é—â–µ–µ ‚û°Ô∏è";
        }

        document.getElementById('next-ex-btn').onclick = () => {
            if(curIdx < curList.length - 1) {
                curIdx++; renderEx();
            } else {
                finishWorkout(true);
            }
        };

        function finishWorkout(success) {
            document.getElementById('training-overlay').style.display = 'none';
            if(success) {
                updateCoins(50);
                tg.showAlert("–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞! +50 –º–æ–Ω–µ—Ç ü™ô");
            }
        }

        // --- –ú–ê–ì–ê–ó–ò–ù ---
        function buyPet(price) {
            if(coins >= price) {
                updateCoins(-price);
                hasPet = true;
                localStorage.setItem('hasPet', 'true');
                document.getElementById('pet-container').style.display = 'block';
                document.getElementById('buyPetBtn').innerText = "–ö—É–ø–ª–µ–Ω–æ";
                document.getElementById('buyPetBtn').disabled = true;
                tg.showAlert("–£ –≤–∞—Å –ø–æ—è–≤–∏–ª—Å—è –ø–∏—Ç–æ–º–µ—Ü!");
            } else {
                tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!");
            }
        }
    </script>
</body>
</html>
